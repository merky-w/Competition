<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Competition sign up</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      /* ===== GLOBAL STYLES ===== */
      body {
        font-family: system-ui, sans-serif;
        max-width: 900px;
        margin: 24px auto;
        padding: 0 16px;
        background-color: #f7f7f7;
        color: #333;
      }

      h2,
      h3,
      h4 {
        margin: 12px 0;
        font-family: "Segoe UI", sans-serif;
      }

      h3 {
        border-bottom: 1px solid #ddd;
        padding-bottom: 4px;
      }

      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }

      .row > * {
        flex: 1 1 200px;
      }

      input,
      select,
      button {
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
        transition:
          border 0.2s ease,
          background-color 0.2s ease,
          transform 0.1s ease;
      }

      input:focus,
      select:focus {
        outline: 2px solid #1976d2;
        background-color: #e3f2fd;
      }

      input[type="number"] {
        -moz-appearance: textfield;
      }
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      button {
        cursor: pointer;
        border: 1px solid #1976d2;
        background-color: #2196f3;
        color: white;
        border-radius: 4px;
      }
      button:hover {
        background-color: #1976d2;
        transform: translateY(-1px);
      }
      button:active {
        transform: translateY(1px);
      }

      /* ===== ERROR STYLING ===== */
      .error {
        border: 2px solid #d32f2f !important;
        background: #ffebee;
      }
      .error-text {
        font-weight: bold;
        color: #d32f2f;
        background-color: #ffebee;
        padding: 4px 8px;
        border-left: 4px solid #d32f2f;
        border-radius: 4px;
        margin: 8px 0;
        display: block;
      }

      .ok-text {
        color: #2e7d32;
        margin: 8px 0;
        font-weight: bold;
      }

      .hidden {
        display: none !important;
      }

      /* ===== SECTIONS ===== */
      .section {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        margin: 12px 0;
        background-color: #fff;
      }

      .list {
        border-top: 1px dashed #ccc;
        padding-top: 8px;
        margin-top: 8px;
        background-color: #fafafa;
        border-radius: 6px;
      }

      .entry {
        margin-bottom: 8px;
        padding: 6px;
        border-bottom: 1px dotted #ccc;
      }

      small {
        font-size: 0.8em;
        color: #555;
      }

      /* ===== GENERATED CARDS ===== */
      #generatedContainer .section {
        margin-bottom: 12px;
      }

      .section.competitor {
        border-left: 4px solid #42a5f5;
      }
      .section.judge {
        border-left: 4px solid #66bb6a;
      }
      .section.coach {
        border-left: 4px solid #ffa726;
      }

      .field-team {
        background-color: #f5f5f5;
      }
    </style>
  </head>
  <body>
    <h2>9-th Vojvodina open ITF teakwondo-championship</h2>

    <!-- AUTH SECTION -->
    <div id="authSection" class="section">
      <h3>Login / Signup</h3>
      <input type="email" id="email" placeholder="Enter your email" />
      <input type="password" id="password" placeholder="Enter your password" />
      <button id="setNewPasswordBtn" class="hidden">Set new password</button>
      <button id="signupBtn">Sign up</button>
      <button id="signinBtn">Sign in</button>
      <button id="forgotBtn" type="button">Forgot password?</button>
    </div>

    <!-- COMPETITION SECTION (HIDDEN UNTIL LOGGED IN) -->
    <div id="competitionSection" class="hidden">
      <div class="row">
        <button id="competitorsBtn">Competitors</button>
        <button id="judgesBtn">Judges</button>
        <button id="coachesBtn">Coaches</button>
      </div>
      <div id="categoryInfo" class="ok-text">Current category: competitors</div>
      <div id="listContainer" class="list"></div>

      <div class="section">
        <h3>Set Team Name</h3>
        <input type="text" id="teamNameInput" placeholder="Team name" />
        <button id="setTeamBtn">Set Team</button>
      </div>

      <div class="section hidden" id="addEntriesSection">
        <h3 id="addEntriesTitle">Add Entries</h3>
        <input type="number" id="countInput" placeholder="How many?" min="1" />
        <button id="generateBtn">Generate fields</button>
        <div id="generatedContainer"></div>
      </div>
    </div>

    <script>
      /* ===== YOUR ORIGINAL JS CODE ===== */
      const SUPABASE_URL = "https://cziwnycosdxeuacslcza.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6aXdueWNvc2R4ZXVhY3NsY3phIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MTkxMDAsImV4cCI6MjA4MjI5NTEwMH0.7OvfatHP7RAp6JS1F5hMlwfdSDgpN7EXsY2SVMoFSoY";
      const client = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY,
      );

      // ===== PASSWORD RECOVERY HANDLING =====
      let isRecoveryFlow = false;

      client.auth.onAuthStateChange((event, session) => {
        if (event === "PASSWORD_RECOVERY") {
          isRecoveryFlow = true;
          alert("You are resetting your password. Please enter a new one.");

          // Hide normal auth buttons
          document.getElementById("signupBtn").style.display = "none";
          document.getElementById("signinBtn").style.display = "none";
          document.getElementById("forgotBtn").style.display = "none";

          // Show reset button
          document
            .getElementById("setNewPasswordBtn")
            .classList.remove("hidden");
        }
      });

      let teamNameGlobal = "";
      let currentCategory = "competitors";
      let currentUserId = null;

      // ===== AUTH HANDLERS =====
      document
        .getElementById("signupBtn")
        .addEventListener("click", async () => {
          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;
          if (!email || !password) return alert("Email and password required.");
          const { error } = await client.auth.signUp({ email, password });
          if (error) alert(error.message);
          else alert("Check your email to confirm signup.");
        });

      document
        .getElementById("signinBtn")
        .addEventListener("click", async () => {
          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;
          if (!email || !password) return alert("Email and password required.");

          const { error } = await client.auth.signInWithPassword({
            email,
            password,
          });
          if (error) {
            alert(error.message);
            return;
          }

          const { data: userData } = await client.auth.getUser();
          if (userData?.user) {
            currentUserId = userData.user.id;
            document.getElementById("authSection").classList.add("hidden");
            document
              .getElementById("competitionSection")
              .classList.remove("hidden");
            loadEntries(); // Load data immediately after login
          } else {
            alert("Authentication succeeded but user data not available.");
          }
        });

      document
        .getElementById("forgotBtn")
        .addEventListener("click", async () => {
          const emailValue = document.getElementById("email").value.trim();
          if (!emailValue) {
            alert("Please enter your email first.");
            return;
          }

          const { error } = await client.auth.resetPasswordForEmail(
            emailValue,
            {
              redirectTo:
                "https://merky-w.github.io/Competition/azta-index.html",
            },
          );

          if (error) {
            alert(error.message);
          } else {
            alert("Password reset email sent. Check your inbox.");
          }
        });

      function updateAddEntriesTitle() {
        const title = document.getElementById("addEntriesTitle");
        if (!title) return;

        if (currentCategory === "competitors")
          title.textContent = "Add Competitor Entries";
        else if (currentCategory === "judges")
          title.textContent = "Add Judge Entries";
        else title.textContent = "Add Coach Entries";
      }

      // ===== SET NEW PASSWORD BUTTON LOGIC =====
      document
        .getElementById("setNewPasswordBtn")
        .addEventListener("click", async () => {
          if (!isRecoveryFlow) {
            alert("This page was not opened from a password reset email.");
            return;
          }

          const newPassword = document.getElementById("password").value;
          if (!newPassword || newPassword.length < 6) {
            alert("Password must be at least 6 characters.");
            return;
          }

          const { error } = await client.auth.updateUser({
            password: newPassword,
          });

          if (error) {
            alert(error.message);
          } else {
            alert("Password updated successfully. You can now log in.");
            location.href =
              "https://merky-w.github.io/Competition/azta-index.html";
          }
        });

      // ===== CATEGORY SWITCHING =====
      function setCategory(cat) {
        currentCategory = cat;
        document.getElementById("categoryInfo").textContent =
          "Current category: " + cat;

        updateAddEntriesTitle();
        loadEntries();
      }

      document.getElementById("competitorsBtn").onclick = () =>
        setCategory("competitors");
      document.getElementById("judgesBtn").onclick = () =>
        setCategory("judges");
      document.getElementById("coachesBtn").onclick = () =>
        setCategory("coaches");

      // ===== DATA LOADING =====
      async function loadEntries() {
        if (!currentUserId) return;

        const { data, error } = await client
          .from(currentCategory)
          .select("*")
          .eq("user_id", currentUserId)
          .limit(50);

        const list = document.getElementById("listContainer");
        list.innerHTML = "";

        if (error) {
          list.textContent = "Error loading.";
          return;
        }

        // âœ… TEAM SUMMARY (always shown)
        const teamInfo = document.createElement("div");
        teamInfo.className = "ok-text";
        const label =
          currentCategory === "competitors"
            ? "Competitors"
            : currentCategory === "judges"
              ? "Judges"
              : "Coaches";

        teamInfo.textContent = `Team: ${
          teamNameGlobal || "Not set"
        } | ${label}: ${data ? data.length : 0}`;

        list.appendChild(teamInfo);

        if (!data || data.length === 0) {
          const empty = document.createElement("div");
          empty.textContent = "No entries yet.";
          list.appendChild(empty);
          return;
        }

        // âœ… ENTRY LIST
        data.forEach((row) => {
          const div = document.createElement("div");
          div.className = "entry";
          div.innerHTML = safeSummary(currentCategory, row);

          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.onclick = async () => {
            await client
              .from(currentCategory)
              .delete()
              .eq("id", row.id)
              .eq("user_id", currentUserId);
            loadEntries();
          };

          div.appendChild(delBtn);
          list.appendChild(div);
        });
      }

      function safeSummary(cat, row) {
        if (cat === "competitors") {
          return `
          <strong>${row.name}</strong> (${row.gender}, ${row.birthdate})<br>
          Belt: ${row.belt}, Weight: ${row.weight} kg<br>
          Team: ${row.team}<br>
          <small>ID: ${row.id}</small>
        `;
        } else if (cat === "judges" || cat === "coaches") {
          return `
          <strong>${row.name}</strong><br>
          Belt: ${row.belt}<br>
          Team: ${row.team}<br>
          <small>ID: ${row.id}</small>
        `;
        }
        return JSON.stringify(row);
      }

      // ===== TEAM SETTING =====
      document.getElementById("setTeamBtn").onclick = () => {
        const input = document.getElementById("teamNameInput");

        // ðŸ”¥ force uppercase
        teamNameGlobal = input.value.trim().toUpperCase();
        input.value = teamNameGlobal; // reflect it back in the input

        if (!teamNameGlobal) {
          alert("Please enter a team name.");
          return;
        }

        alert("Team set: " + teamNameGlobal);

        document.getElementById("addEntriesSection").classList.remove("hidden");

        updateAddEntriesTitle();
        loadEntries(); // optional but useful
      };

      // ===== FORM GENERATION & VALIDATION =====
      const container = document.getElementById("generatedContainer");
      function clearGenerated() {
        container.innerHTML = "";
      }

      function beltSelect() {
        return `<select class="field-belt">
        <option value="">Belt *</option>
        <option>10 kup</option><option>9 kup</option><option>8 kup</option>
        <option>7 kup</option><option>6 kup</option><option>5 kup</option>
        <option>4 kup</option><option>3 kup</option><option>2 kup</option>
        <option>1 kup</option><option>1 dan</option><option>2 dan</option>
        <option>3 dan</option><option>4 dan</option><option>5 dan</option>
        <option>6 dan</option>
      </select>`;
      }

      function makeCompetitorCard(idx) {
        const wrap = document.createElement("div");
        wrap.className = "section competitor";
        wrap.innerHTML = `
        <h4>Competitor #${idx}</h4>
        <div class="row">
          <input class="field-name" type="text" placeholder="Name *" />
          <input class="field-birthdate" type="date" />
          <select class="field-gender">
            <option value="">Gender *</option>
            <option>Male</option><option>Female</option>
          </select>
        </div>
        <div class="row">
          ${beltSelect()}
          <input class="field-team" type="text" placeholder="Team *" value="${teamNameGlobal}" />
          <input class="field-weight" type="number" step="0.1" placeholder="Real weight (example 33 kg) *" />
        </div>
        <div class="error-text hidden"></div>
      `;
        return wrap;
      }

      function makeJudgeCard(idx) {
        const wrap = document.createElement("div");
        wrap.className = "section judge";
        wrap.innerHTML = `
        <h4>Judge #${idx}</h4>
        <div class="row">
          <input class="field-name" type="text" placeholder="Name *" />
          ${beltSelect()}
          <input class="field-team" type="text" placeholder="Team *" value="${teamNameGlobal}" />
        </div>
        <div class="error-text hidden"></div>
      `;
        return wrap;
      }

      function makeCoachCard(idx) {
        const wrap = document.createElement("div");
        wrap.className = "section coach";
        wrap.innerHTML = `
        <h4>Coach #${idx}</h4>
        <div class="row">
          <input class="field-name" type="text" placeholder="Name *" />
          ${beltSelect()}
          <input class="field-team" type="text" placeholder="Team *" value="${teamNameGlobal}" />
        </div>
        <div class="error-text hidden"></div>
      `;
        return wrap;
      }

      function markMissing(input) {
        input.classList.add("error"); // add red border
      }

      function showError(wrap, msg) {
        const el = wrap.querySelector(".error-text");
        el.textContent = msg;
        el.classList.remove("hidden");
        setTimeout(() => el.classList.add("hidden"), 2500);
      }

      function getCompetitorData(wrap) {
        const name = wrap.querySelector(".field-name").value.trim();
        const birthdate = wrap.querySelector(".field-birthdate").value.trim();
        const gender = wrap.querySelector(".field-gender").value.trim();
        const belt = wrap.querySelector(".field-belt").value.trim();
        const team = wrap.querySelector(".field-team").value.trim();
        const weight = wrap.querySelector(".field-weight").value;

        const required = [
          [name, wrap.querySelector(".field-name"), "Name missing"],
          [
            birthdate,
            wrap.querySelector(".field-birthdate"),
            "Birthdate missing",
          ],
          [gender, wrap.querySelector(".field-gender"), "Gender missing"],
          [belt, wrap.querySelector(".field-belt"), "Belt missing"],
          [team, wrap.querySelector(".field-team"), "Team missing"],
          [weight, wrap.querySelector(".field-weight"), "Weight missing"],
        ];
        for (const [val, el, msg] of required) {
          if (!val) {
            markMissing(el);
            showError(wrap, msg);
            return null;
          }
        }
        return { name, birthdate, gender, belt, team, weight: Number(weight) };
      }

      function getJudgeData(wrap) {
        const name = wrap.querySelector(".field-name").value.trim();
        const belt = wrap.querySelector(".field-belt").value.trim();
        const team = wrap.querySelector(".field-team").value.trim();
        if (!name || !belt || !team) {
          showError(wrap, "Missing fields");
          return null;
        }
        return { name, belt, team };
      }

      function getCoachData(wrap) {
        const name = wrap.querySelector(".field-name").value.trim();
        const belt = wrap.querySelector(".field-belt").value.trim();
        const team = wrap.querySelector(".field-team").value.trim();
        if (!name || !belt || !team) {
          showError(wrap, "Missing fields");
          return null;
        }
        return { name, belt, team };
      }

      // ===== ADD ALL BUTTON =====
      document.getElementById("generateBtn").addEventListener("click", () => {
        if (!currentUserId) {
          alert("You must be logged in to add entries.");
          return;
        }
        const count = parseInt(
          document.getElementById("countInput").value || "0",
          10,
        );
        if (isNaN(count) || count < 1) {
          alert("Please enter a valid number â‰¥ 1");
          return;
        }
        clearGenerated();
        for (let i = 0; i < count; i++) {
          if (currentCategory === "competitors")
            container.appendChild(makeCompetitorCard(i + 1));
          else if (currentCategory === "judges")
            container.appendChild(makeJudgeCard(i + 1));
          else container.appendChild(makeCoachCard(i + 1));
        }
        const addAll = document.createElement("button");
        addAll.textContent = `Add all ${currentCategory}`;
        addAll.type = "button";
        addAll.id = "addAllBtn";
        addAll.style.marginTop = "12px";
        addAll.addEventListener("click", onAddAll);
        container.appendChild(addAll);
      });

      async function onAddAll() {
        if (!currentUserId) {
          alert("You must be logged in to add entries.");
          return;
        }

        // Map currentCategory to actual card class names
        let cardClass =
          currentCategory === "competitors"
            ? "competitor"
            : currentCategory === "judges"
              ? "judge"
              : "coach";

        const cards = Array.from(
          container.querySelectorAll(".section." + cardClass),
        );
        if (cards.length === 0) {
          alert("No cards generated. Please click 'Generate fields' first.");
          return;
        }

        let rows = [];
        let skipped = 0;
        let hasError = false;

        for (const c of cards) {
          const inputs = Array.from(c.querySelectorAll("input, select"));

          // Check if all non-team fields are empty
          const nonTeamFields = inputs.filter(
            (el) => !el.classList.contains("field-team"),
          );
          const allNonTeamEmpty = nonTeamFields.every((el) => !el.value.trim());

          if (allNonTeamEmpty) {
            skipped++; // completely empty card except team â†’ skip it
            continue;
          }

          // Partially filled card â†’ validate required fields
          let data = null;
          if (currentCategory === "competitors") data = getCompetitorData(c);
          else if (currentCategory === "judges") data = getJudgeData(c);
          else data = getCoachData(c);

          if (!data) {
            // Highlight missing fields in red
            nonTeamFields.forEach((el) => {
              if (!el.value.trim()) markMissing(el);
            });

            showError(c, "Fill all required fields or leave entry empty");
            hasError = true;
            continue;
          }

          rows.push({ ...data, user_id: currentUserId });
        }

        if (hasError) {
          alert(
            "Some entries are incomplete. Fill all required fields or leave entries empty.",
          );
          return; // stop adding
        }

        if (rows.length === 0) {
          alert("No valid entries to add.");
          return;
        }

        // Insert valid entries into Supabase
        const { error } = await client.from(currentCategory).insert(rows);

        if (error) {
          console.error(error);
          alert(`Failed to add ${currentCategory}: ${error.message}`);
        } else {
          let msg = `Added ${rows.length} ${currentCategory}.`;
          if (skipped > 0) msg += ` Skipped ${skipped} empty entries.`;
          alert(msg);
          clearGenerated();
          loadEntries();
        }
      }
    </script>
  </body>
</html>
